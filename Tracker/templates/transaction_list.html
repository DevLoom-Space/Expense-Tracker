{% extends "base.html" %}
{% load money %}

{% block title %}Transactions{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-4">
  <div>
    <h1 class="h3 mb-1 app-title">Transactions</h1>
    <p class="mb-0 text-muted-2">Manage, filter, export and review your money flow.</p>
  </div>

  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-accent btn-sm" href="{% url 'transaction_create' %}">
      <i class="bi bi-plus-circle me-1"></i> Add Transaction
    </a>
    <a class="btn btn-outline-light btn-sm" href="{% url 'transaction_export' %}">
      <i class="bi bi-download me-1"></i> Export CSV
    </a>
    <a class="btn btn-outline-light btn-sm" href="{% url 'category_list' %}">
      <i class="bi bi-tags me-1"></i> Categories
    </a>
    <a class="btn btn-outline-light btn-sm" href="{% url 'budget_list' %}">
      <i class="bi bi-pie-chart me-1"></i> Budgets
    </a>
  </div>
</div>

<!-- Filters -->
<div class="card app-card p-3 mb-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
    <h2 class="h5 mb-0">
      <i class="bi bi-funnel me-2"></i>Filters
    </h2>

    <a class="btn btn-sm btn-outline-light" href="{% url 'transaction_list' %}">
      <i class="bi bi-x-circle me-1"></i> Clear
    </a>
  </div>

  <form method="get" class="row g-2 align-items-end">
    <div class="col-12 col-md-3">
      <label class="form-label small text-muted-2 mb-1">Type</label>
      <select class="form-select form-select-sm" name="type">
        <option value="">All Types</option>
        <option value="EXPENSE" {% if current.type == "EXPENSE" %}selected{% endif %}>Expense</option>
        <option value="INCOME" {% if current.type == "INCOME" %}selected{% endif %}>Income</option>
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label small text-muted-2 mb-1">Wallet</label>
      <select class="form-select form-select-sm" name="wallet">
        <option value="">All Wallets</option>
        {% for w in wallets %}
          <option value="{{ w.id }}" {% if current.wallet == w.id|stringformat:"s" %}selected{% endif %}>
            {{ w.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label small text-muted-2 mb-1">Category</label>
      <select class="form-select form-select-sm" name="category">
        <option value="">All Categories</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if current.category == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-1">
      <label class="form-label small text-muted-2 mb-1">From</label>
      <input class="form-control form-control-sm" type="date" name="date_from" value="{{ current.date_from }}">
    </div>

    <div class="col-6 col-md-1">
      <label class="form-label small text-muted-2 mb-1">To</label>
      <input class="form-control form-control-sm" type="date" name="date_to" value="{{ current.date_to }}">
    </div>

    <div class="col-12 col-md-10">
      <label class="form-label small text-muted-2 mb-1">Search (note)</label>
      <input class="form-control form-control-sm" type="text" name="search"
             placeholder="e.g. lunch, rent, salary..." value="{{ current.search }}">
    </div>

    <div class="col-12 col-md-2">
      <button class="btn btn-accent btn-sm w-100" type="submit">
        <i class="bi bi-search me-1"></i> Apply
      </button>
    </div>
  </form>
</div>

<!-- Transactions Table -->
<div class="card app-card p-3">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
    <h2 class="h5 mb-0">
      <i class="bi bi-receipt me-2"></i>Results
    </h2>

    <span class="text-muted-2 small">
      {% if page_obj %}
        Showing {{ page_obj.paginator.count }} record(s)
      {% else %}
        Showing {{ transactions|length }} record(s)
      {% endif %}
    </span>
  </div>

  <div class="table-responsive">
    <table class="table app-table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Date</th>
          <th>Wallet</th>
          <th>Type</th>
          <th class="text-end">Amount</th>
          <th>Category</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
          <tr>
            <td class="text-nowrap">{{ t.date }}</td>
            <td class="text-nowrap">
              <i class="bi bi-wallet2 me-2"></i>{{ t.wallet.name }}
            </td>

            <td>
              {% if t.t_type == "EXPENSE" %}
                <span class="badge text-bg-warning">
                  <i class="bi bi-arrow-up-right-circle me-1"></i>Expense
                </span>
              {% else %}
                <span class="badge text-bg-success">
                  <i class="bi bi-arrow-down-left-circle me-1"></i>Income
                </span>
              {% endif %}
            </td>

            <td class="text-end fw-semibold">{{ t.amount|kes }}</td>
            <td>{{ t.category|default:"â€”" }}</td>

            <td class="text-end">
              <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                <a class="btn btn-outline-light" title="View" href="{% url 'transaction_detail' t.pk %}">
                  <i class="bi bi-eye"></i>
                </a>
                <a class="btn btn-outline-light" title="Edit" href="{% url 'transaction_update' t.pk %}">
                  <i class="bi bi-pencil"></i>
                </a>
                <a class="btn btn-outline-danger" title="Delete" href="{% url 'transaction_delete' t.pk %}">
                  <i class="bi bi-trash"></i>
                </a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="text-muted-2">No transactions found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination (keeps filters) -->
  {% if is_paginated %}
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
      <div class="small text-muted-2">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </div>

      <div class="btn-group btn-group-sm">

        {% if page_obj.has_previous %}
          <a class="btn btn-outline-light"
             href="?page={{ page_obj.previous_page_number }}
             {% if current.type %}&type={{ current.type }}{% endif %}
             {% if current.wallet %}&wallet={{ current.wallet }}{% endif %}
             {% if current.category %}&category={{ current.category }}{% endif %}
             {% if current.date_from %}&date_from={{ current.date_from }}{% endif %}
             {% if current.date_to %}&date_to={{ current.date_to }}{% endif %}
             {% if current.search %}&search={{ current.search|urlencode }}{% endif %}">
            <i class="bi bi-chevron-left me-1"></i>Prev
          </a>
        {% else %}
          <button class="btn btn-outline-light" disabled>
            <i class="bi bi-chevron-left me-1"></i>Prev
          </button>
        {% endif %}

        {% if page_obj.has_next %}
          <a class="btn btn-outline-light"
             href="?page={{ page_obj.next_page_number }}
             {% if current.type %}&type={{ current.type }}{% endif %}
             {% if current.wallet %}&wallet={{ current.wallet }}{% endif %}
             {% if current.category %}&category={{ current.category }}{% endif %}
             {% if current.date_from %}&date_from={{ current.date_from }}{% endif %}
             {% if current.date_to %}&date_to={{ current.date_to }}{% endif %}
             {% if current.search %}&search={{ current.search|urlencode }}{% endif %}">
            Next<i class="bi bi-chevron-right ms-1"></i>
          </a>
        {% else %}
          <button class="btn btn-outline-light" disabled>
            Next<i class="bi bi-chevron-right ms-1"></i>
          </button>
        {% endif %}

      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
