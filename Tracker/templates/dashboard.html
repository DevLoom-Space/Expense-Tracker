{% extends "base.html" %}
{% load money %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-4">
  <div>
    <h1 class="h3 mb-1 app-title">Dashboard</h1>
    <p class="mb-0 text-muted-2">Your monthly snapshot: income, expenses, budgets & recent activity.</p>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-accent btn-sm" href="{% url 'transaction_create' %}">
      <i class="bi bi-plus-circle me-1"></i> Add Transaction
    </a>
    <a class="btn btn-outline-light btn-sm" href="{% url 'budget_list' %}">
      <i class="bi bi-pie-chart me-1"></i> Budgets
    </a>
  </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="card app-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="text-muted-2 small">This Month Income</div>
          <div class="h4 mb-0">{{ month_income_total|kes }}</div>
        </div>
        <span class="badge badge-soft">
          <i class="bi bi-arrow-down-left-circle me-1"></i>Income
        </span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card app-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="text-muted-2 small">This Month Expenses</div>
          <div class="h4 mb-0">{{ month_expense_total|kes }}</div>
        </div>
        <span class="badge badge-soft">
          <i class="bi bi-arrow-up-right-circle me-1"></i>Expense
        </span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card app-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="text-muted-2 small">Net Balance</div>
          <div class="h4 mb-0">{{ net_balance|kes }}</div>
        </div>
        <span class="badge badge-soft">
          <i class="bi bi-graph-up-arrow me-1"></i>Net
        </span>
      </div>
      <div class="mt-2 small text-muted-2">
        Net = Income − Expenses
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Expense Breakdown + Chart -->
  <div class="col-12 col-lg-6">
    <div class="card app-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">
          <i class="bi bi-bar-chart-line me-2"></i>Expense Breakdown (This Month)
        </h2>
        <a class="btn btn-outline-light btn-sm" href="{% url 'category_list' %}">
          <i class="bi bi-tags me-1"></i> Categories
        </a>
      </div>

      <div class="row g-3 align-items-center">
        <div class="col-12 col-md-6">
          <div class="table-responsive">
            <table class="table app-table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Category</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                {% for item in category_breakdown %}
                  <tr>
                    <td class="text-nowrap">
                      <i class="bi bi-tag me-2"></i>
                      {{ item.category__name|default:"No Category" }}
                    </td>
                    <td class="text-end fw-semibold">{{ item.total|kes }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="2" class="text-muted-2">No expenses yet.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="small text-muted-2 mt-2">Top spending categories this month.</div>
        </div>

        <div class="col-12 col-md-6">
          {% if category_breakdown %}
            <canvas id="breakdownChart" height="210"></canvas>
            <div class="small text-muted-2 mt-2">Visual breakdown by category.</div>
          {% else %}
            <div class="p-4 text-center text-muted-2 border rounded-3">
              <i class="bi bi-info-circle me-1"></i>
              Add an expense transaction to see the breakdown chart.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Budget Usage (Progress Bars) -->
  <div class="col-12 col-lg-6">
    <div class="card app-card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">
          <i class="bi bi-exclamation-triangle me-2"></i>Budget Usage (This Month)
        </h2>
        <a class="btn btn-outline-light btn-sm" href="{% url 'budget_list' %}">
          <i class="bi bi-gear me-1"></i> Manage
        </a>
      </div>

      <div class="table-responsive">
        <table class="table app-table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Category</th>
              <th class="text-end">Usage</th>
            </tr>
          </thead>
          <tbody>
            {% for b in budget_alerts %}
              <tr>
                <td class="text-nowrap">
                  <i class="bi bi-bookmark me-2"></i>{{ b.category }}
                </td>

                <td class="text-end">
                  {# Safe percent calculation #}
                  {% if b.limit and b.limit > 0 %}
                    {% widthratio b.spent b.limit 100 as percent %}
                  {% else %}
                    {% with percent=0 %}{% endwith %}
                  {% endif %}

                  {% if percent > 100 %}
                    {% with percent=100 %}{% endwith %}
                  {% endif %}

                  <div class="progress">
                    <div class="progress-bar {% if b.is_exceeded %}bg-danger{% else %}bg-success{% endif %}"
                         role="progressbar"
                         style="width: {{ percent }}%"
                         aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>

                  <div class="small text-muted-2 mt-1">
                    {{ b.spent|kes }} / {{ b.limit|kes }} ({{ percent }}%)
                    {% if b.is_exceeded %}
                      <span class="badge text-bg-danger ms-2">
                        Exceeded {{ b.over|kes }}
                      </span>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2" class="text-muted-2">No budgets set for this month.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-2 small text-muted-2">
        Tip: Budgets give you early warning before overspending.
      </div>
    </div>
  </div>

  <!-- 6-Month Trend Chart -->
  <div class="col-12">
    <div class="card app-card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">
          <i class="bi bi-graph-up me-2"></i>6-Month Trend (Income vs Expense)
        </h2>
        <a class="btn btn-outline-light btn-sm" href="{% url 'transaction_list' %}">
          <i class="bi bi-receipt me-1"></i> View All
        </a>
      </div>

      {% if monthly_history %}
        <canvas id="trendChart" height="90"></canvas>
        <div class="small text-muted-2 mt-2">Income vs Expense from the last 6 months.</div>
      {% else %}
        <div class="p-4 text-center text-muted-2 border rounded-3">
          <i class="bi bi-graph-up me-1"></i>
          Add transactions across months to see the trend.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="col-12">
    <div class="card app-card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">
          <i class="bi bi-clock-history me-2"></i>Recent Transactions
        </h2>
        <a class="btn btn-outline-light btn-sm" href="{% url 'transaction_list' %}">
          <i class="bi bi-receipt me-1"></i> View All
        </a>
      </div>

      <div class="table-responsive">
        <table class="table app-table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Wallet</th>
              <th>Type</th>
              <th class="text-end">Amount</th>
              <th>Category</th>
            </tr>
          </thead>
          <tbody>
            {% for t in recent_transactions %}
              <tr>
                <td class="text-nowrap">{{ t.date }}</td>
                <td class="text-nowrap"><i class="bi bi-wallet2 me-2"></i>{{ t.wallet.name }}</td>
                <td>
                  {% if t.t_type == "EXPENSE" %}
                    <span class="badge text-bg-warning">
                      <i class="bi bi-arrow-up-right-circle me-1"></i>Expense
                    </span>
                  {% else %}
                    <span class="badge text-bg-success">
                      <i class="bi bi-arrow-down-left-circle me-1"></i>Income
                    </span>
                  {% endif %}
                </td>
                <td class="text-end fw-semibold">{{ t.amount|kes }}</td>
                <td>{{ t.category|default:"—" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-muted-2">No transactions yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{# Chart Data JSON #}
<script id="category-data" type="application/json">
[
  {% for item in category_breakdown %}
    {"name":"{{ item.category__name|default:'No Category'|escapejs }}","total":{{ item.total|default:0 }} }{% if not forloop.last %},{% endif %}
  {% endfor %}
]
</script>

<script id="trend-data" type="application/json">
[
  {% for row in monthly_history %}
    {"month":"{{ row.month|date:'Y-m' }}","type":"{{ row.t_type }}","total":{{ row.total|default:0 }} }{% if not forloop.last %},{% endif %}
  {% endfor %}
]
</script>
{% endblock %}

{% block extra_js %}
<script>
  // Expense Breakdown Doughnut
  const catData = JSON.parse(document.getElementById("category-data")?.textContent || "[]");
  const catLabels = catData.map(x => x.name);
  const catTotals = catData.map(x => x.total);

  const breakdownEl = document.getElementById("breakdownChart");
  if (breakdownEl && catData.length && window.Chart) {
    new Chart(breakdownEl, {
      type: "doughnut",
      data: { labels: catLabels, datasets: [{ data: catTotals }] },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } }
      }
    });
  }

  // 6-Month Trend Line (Income vs Expense)
  const trendData = JSON.parse(document.getElementById("trend-data")?.textContent || "[]");

  // Sort months properly (chronological)
  const months = [...new Set(trendData.map(x => x.month))].sort();

  const incomeMap = Object.fromEntries(months.map(m => [m, 0]));
  const expenseMap = Object.fromEntries(months.map(m => [m, 0]));

  trendData.forEach(r => {
    if (r.type === "INCOME") incomeMap[r.month] = r.total;
    if (r.type === "EXPENSE") expenseMap[r.month] = r.total;
  });

  const incomeSeries = months.map(m => incomeMap[m]);
  const expenseSeries = months.map(m => expenseMap[m]);

  const trendEl = document.getElementById("trendChart");
  if (trendEl && months.length && window.Chart) {
    new Chart(trendEl, {
      type: "line",
      data: {
        labels: months,
        datasets: [
          { label: "Income", data: incomeSeries, tension: 0.35 },
          { label: "Expense", data: expenseSeries, tension: 0.35 }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>
{% endblock %}
